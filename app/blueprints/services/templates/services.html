{% from 'macros/summary_panel.html' import summary_panel %}
{% from 'macros/search_bar.html' import search_bar %}
{% extends "core.html" %}

{% block title %}Services - LoStack Admin{% endblock %}
{% block page_title %}
<i class="bi bi-rocket-takeoff-fill me-2"></i>
LoStack Services
{% endblock %}


{% macro render_routing(service, request) %}
<div>
  <div class="d-flex justify-content-between align-items-center mb-0">
    <h6 class="small fw-bold text-muted mb-1">
      <i class="bi bi-signpost-split-fill me-1 text-secondary"></i>Routing
    </h6>
    <div class="small d-flex gap-2 flex-wrap">
      <a href="{{ url_for('services.service_edit', service_id=service.id) }}"
        class="btn btn-sm btn-outline-primary btn-action py-0 px-3" title="Edit Service">
        <i class="bi bi-pencil"></i>
      </a>
      {% if not service.core_service %}
      <button class="btn btn-sm btn-outline-danger btn-action py-0 px-3" 
        onclick="showDeleteConfirmation({{ service.id }}, '{{ service.display_name_or_name }}', '{{ url_for("depot.depot_remove", service_id=service.id) }}')"
        title="Uninstall Service"
      >
        <i class="bi bi-trash3"></i>
      </button>
      {% endif %}
      <button class="btn btn-sm btn-outline-{{ 'success' if service.enabled else 'secondary' }} btn-action py-0 px-2"
        onclick="toggleService({{ service.id }})"
        title="{{ 'Disable' if service.enabled else 'Enable' }} Traefik routing"
        style="min-width: 60px;">
        <i class="bi bi-{{ 'toggle-on' if service.enabled else 'toggle-off' }} me-1"></i>
        {{ 'On' if service.enabled else 'Off' }}
      </button>
    </div>
  </div>
  <div class="small mb-0">
    <div class="ms-2 me-0 general-item d-flex generic-item flex-wrap align-items-baseline mb-1">
      <i class="bi bi-signpost me-2 text-secondary"></i>
      <code class="small item-break">
        {% if service.root %}
          <a href="https://{{ request.host.split('.', 1)[1]}}/" target="_blank" class="text-decoration-none item-break">
            https://{{ request.host.split('.', 1)[1]}}/
            <i class="bi bi-box-arrow-up-right ms-1"></i>
          </a>
        {% else %}
          <a href="https://{{ service.name }}.{{ request.host.split('.', 1)[1]}}/" target="_blank" class="text-decoration-none item-break">
            https://{{ service.name }}.{{ request.host.split('.', 1)[1]}}/
            <i class="bi bi-box-arrow-up-right ms-1"></i>
          </a>
        {% endif %}
      </code>
      <i class="bi bi-arrow-right mx-2"></i>
      <code class="item-break">{{ service.name }}:{{ service.port }}</code>
    </div>
  </div>
</div>
{% endmacro %}

{% macro render_access(service, request) %}
<div>
  <div class="d-flex justify-content-between align-items-center mb-0 mt-3">
    <h6 class="small fw-bold text-muted mb-1">
      <i class="bi bi-stoplights-fill me-1 text-secondary"></i>Access Control
    </h6>
    <div class="small d-flex gap-2 flex-wrap">
      <button class="btn btn-sm btn-outline-{{ 'success' if service.lostack_access_enabled else 'secondary' }} btn-action py-0 px-2"
        onclick="toggleServiceAccessControl({{ service.id }})"
        title="{{ 'Disable' if service.lostack_access_enabled else 'Enable' }} Access control"
        style="min-width: 60px;">
        <i class="bi bi-{{ 'toggle-on' if service.lostack_access_enabled else 'toggle-off' }} me-1"></i>
        {{ 'On' if service.lostack_access_enabled else 'Off' }}
      </button>
    </div>
  </div>
  <div class="small mb-0">
    {% for group in service.allowed_groups %}
    <div class="ms-2 me-0 general-item d-flex generic-item flex-wrap align-items-baseline mb-1">
      <i class="bi bi-people me-2 text-secondary"></i>
      <code class="small item-break">
        {{ group }}
      </code>
    </div>
    {% endfor %}
  </div>
</div>
{% endmacro %}

{% macro render_autoupdate(service) %}
<div>
  <div class="d-flex justify-content-between align-items-center mb-0 mt-3">
    <h6 class="small fw-bold text-muted mb-1">
      <i class="bi bi-arrow-up-square-fill me-1 text-secondary"></i>Update on Autostart
    </h6>
    <div class="small d-flex gap-2 flex-wrap">
      <button class="btn btn-sm btn-outline-{{ 'success' if service.lostack_autoupdate_enabled else 'secondary' }} btn-action py-0 px-2"
        onclick="toggleServiceAutoupdate({{ service.id }})"
        title="{{ 'Disable' if service.lostack_autoupdate_enabled else 'Enable' }} Auto Update"
        style="min-width: 60px;">
        <i class="bi bi-{{ 'toggle-on' if service.lostack_autoupdate_enabled else 'toggle-off' }} me-1"></i>
        {{ 'On' if service.lostack_autoupdate_enabled else 'Off' }}
      </button>
    </div>
  </div>
</div>
{% endmacro %}

{% macro render_autostart_section(key, value, icon) %}
<div class="col-4 mx-0 px-0">
  <div class="ms-0 me-1 generic-item d-flex flex-wrap align-items-baseline mb-1">
    <i class="bi {{ icon }} me-2 text-secondary"></i>
    <code class="item-break text-primary">{{ key }}:</code>&nbsp;
    <code class="small item-break">{{ value }}</code>
  </div>
</div>
{% endmacro %}

{% macro render_autostart(service) %}
<div>
  <div class="d-flex justify-content-between align-items-center mb-0 mt-3">
    <h6 class="small fw-bold text-muted mb-1">
      <i class="bi bi-rocket-fill me-1 text-secondary"></i>Autostart
    </h6>
    <div class="small d-flex gap-2 flex-wrap">
      <button class="btn btn-sm btn-outline-{{ 'success' if service.lostack_autostart_enabled else 'secondary' }} btn-action py-0 px-2"
        onclick="toggleServiceAutostart({{ service.id }})"
        title="{{ 'Disable' if service.lostack_autostart_enabled else 'Enable' }} Sablier autostart"
        style="min-width: 60px;">
        <i class="bi bi-{{ 'toggle-on' if service.lostack_autostart_enabled else 'toggle-off' }} me-1"></i>
        {{ 'On' if service.lostack_autostart_enabled else 'Off' }}
      </button>
    </div>
  </div>
  <div class="small ms-2 me-0 row mb-0">
    {{ render_autostart_section("Duration", service.session_duration, "bi-hourglass-split" ) }}
    {{ render_autostart_section("Refresh", service.refresh_frequency, "bi-arrow-clockwise" ) }}
  </div>
</div>
{% endmacro %}

{% macro render_containers_action(service, action, class, icon) %}
<button class="btn btn-sm btn-outline-{{class}} btn-action py-0 px-3" 
  onclick="serviceActionWithTerminal('{{ url_for("services.service_action", service_id=service.id, action=action) }}', '{{ service.display_name_or_name }} - {{ action|title }}}')"
  title="{{ action|title }} all containers"
>
<i class="bi {{ icon }}"></i>
</button>
{% endmacro %}

{% macro render_container_ports(container) %}
{% if container and container.get("Ports") %}
<div class="ms-3 mt-0">
  <strong class="small fw-bold text-muted mb-1">
    <i class="bi bi-plug-fill me-1 text-secondary"></i>Ports
  </strong>
  <div class="small text-muted">
    {% for port in container.get("Ports", []) %}
      {% set ip = port.get("IP", "") + ":" + port.get("PublicPort", "")|string if port.get("IP") and port.get("PublicPort") else "<i>not exposed</i>" %}
      {% set private_port = port.get("PrivatePort", "-")|string %}
      {% set port_type = port.get("Type", "").upper() %}
      <div class="ms-2 me-0 port-item secondary-item d-flex align-items-center justify-content-between mb-0">
        <div>
          <i class="bi bi-plug me-2 text-secondary"></i>
          <code class="text-primary item-break">{{ ip|safe }}</code>
          <i class="bi bi-arrow-right mx-2"></i>
          <code class="item-break">{{ private_port }}</code>
        </div>
        <span class="badge rounded-pill bg-info ms-2">{{ port_type }}</span>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endmacro %}

{% macro render_container_volumes(container) %}
{% set mounts = (container or {}).get("Mounts", []) %}
{% set bind_mounts = mounts|selectattr("Type", "equalto", "bind")|list %}
{% if bind_mounts %}
<div class="ms-3 mt-0">
  <strong class="small fw-bold text-muted mb-1">
    <i class="bi bi-folder-fill me-1 text-secondary"></i>Volumes
  </strong>
  <div class="small mb-0">
    {% for mount in bind_mounts %}
      <div class="ms-2 me-0 volume-item secondary-item d-flex align-items-center justify-content-between mb-0">
        <div class="d-flex align-items-baseline flex-wrap">
          <i class="bi bi-folder me-2 text-secondary"></i>
          <code class="text-primary item-break">{{ mount["Source"] }}</code>
          <i class="bi bi-arrow-right mx-2"></i>
          <code class="item-break">{{ mount["Destination"] }}</code>
        </div>
        <span class="badge rounded-pill bg-dark ms-2">
          {{ mount["Mode"]|upper }}
        </span>
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endmacro %}

{% macro render_container_labels(container) %}
{% set labels = (container or {}).get("Labels", {}) %}
{% if labels %}
<div class="ms-3 mt-0">
  <strong class="small fw-bold text-muted mb-1" data-bs-toggle="collapse" data-bs-target="#labels-{{ container.get('Id', 'unknown')[:12] }}" style="cursor: pointer;">
    <i class="bi bi-chevron-right me-1 text-secondary"></i>
    <i class="bi bi-tags-fill me-1 text-secondary"></i>Labels
    <span class="badge rounded-pill bg-light text-dark ms-2">{{ labels|length }}</span>
  </strong>
  <div id="labels-{{ container.get('Id', 'unknown')[:12] }}" class="collapse">
    <div class="small text-muted">
      {% for key, value in labels.items() %}
        <div class="ms-2 me-0 label-item secondary-item d-flex align-items-center justify-content-between mb-0">
          <div class="d-flex align-items-baseline flex-wrap">
            <i class="bi bi-tag me-2 text-secondary"></i>
            <code class="text-primary item-break">{{ key }}</code>
            <i class="bi bi-arrow-right mx-2"></i>
            <code class="item-break">{{ value }}</code>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}
{% endmacro %}

{% macro render_container_networks(container) %}
{% set network_settings = (container or {}).get("NetworkSettings", {}) %}
{% set networks = network_settings.get("Networks", {}) %}
{% if networks %}
<div class="ms-3 mt-0">
  <strong class="small fw-bold text-muted mb-1">
    <i class="bi bi-diagram-3-fill me-1 text-secondary"></i>Networks
  </strong>
  <div class="small text-muted">
    {% for network_name, network_info in networks.items() %}
      {% set ip_address = network_info.get("IPAddress", "") %}
      {% set gateway = network_info.get("Gateway", "") %}
      <div class="ms-2 me-0 network-item secondary-item mb-1">
        <div class="d-flex align-items-center justify-content-between mb-0">
          <div class="d-flex align-items-baseline flex-wrap">
            <i class="bi bi-diagram-3 me-2 text-secondary"></i>
            <code class="text-primary item-break">{{ network_name }}</code>
            {% if ip_address %}
              <i class="bi bi-arrow-right mx-2"></i>
              <code class="item-break">{{ ip_address }}</code>
            {% endif %}
          </div>
        </div>
        {% if gateway %}
          <div class="ms-4 small text-muted">
            <i class="bi bi-router me-2"></i>
            Gateway: <code class="item-break">{{ gateway }}</code>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>
{% endif %}
{% endmacro %}

{% macro render_containers(service, containers) %}
<div class="d-flex justify-content-between align-items-center mb-0 mt-3">
  <h6 class="small fw-bold text-muted mb-0">
    <i class="bi bi-boxes me-1 text-secondary"></i>Containers
  </h6>
  <div class="small d-flex gap-2 flex-wrap">
    {{ render_containers_action(service, "up", "success", "bi-play") }}
    {{ render_containers_action(service, "stop", "secondary", "bi-stop") }}
    {{ render_containers_action(service, "remove", "danger", "bi-trash") }}
  </div>
</div>
<div class="small mb-0">
  {% for name in service.service_names.split(",") %}
    {% set container = containers.get(name.strip(), {}) or {} %}
    {% set status = container.get("Status", "Not Found") %}
    <div class="mb-3">
      <div class="ms-2 me-0 pe-0 volume-item d-flex align-items-center justify-content-between mb-0">
        <div class="">
          <i class="bi bi-box me-0 text-secondary me-1"></i>
          <code class="text-primary item-break">{{ name.strip() }}</code>
        </div>

        <span class="badge rounded-pill
        {% if 'Up' in status %}bg-success
        {% elif 'Starting' in status %}bg-primary
        {% elif 'Exited' in status %}bg-secondary
        {% else %}bg-danger{% endif %}
        ">
          {{ status }}
        </span>
      </div>

      {{ render_container_ports(container) }}
      {{ render_container_volumes(container) }}
      {{ render_container_networks(container) }}
      {{ render_container_labels(container) }}
    </div>
  {% endfor %}
</div>
{% endmacro %}

{% macro service_card(service, containers) %}
<div class="col-lg-6 col-xxl-4 mb-0">
  <div class="card shadow service-card {% if not service.enabled %}service-disabled{% endif %}">
    <div class="card-header
      {% if service.enabled %}
        {% if service.core_service %}
          bd-indigo-700 text-light
        {% else %}
          bg-primary text-light
        {% endif %}
      {% else %}
        bg-dark text-light
      {% endif %}"
    >
      <div class="d-flex justify-content-between align-items-start">
        
        <div class="d-flex flex-column">
          <h6 class="fw-semibold mb-0" for="service-{{ service.id }}">
            {{ service.display_name_or_name }}
          </h6>

          <div class="service-status mt-0">
            {% set container_statuses = [] %}
            {% for name in service.service_names.split(",") %}
              {% set container = containers.get(name.strip(), {}) or {} %}
              {% set status = container.get("Status", "Not Found") %}
              {% if 'Up' in status %}
                {% set _ = container_statuses.append(true) %}
              {% else %}
                {% set _ = container_statuses.append(false) %}
              {% endif %}
            {% endfor %}
            
            {% set total_containers = container_statuses|length %}
            {% set up_containers = container_statuses|select|list|length %}
            
            {% if up_containers == total_containers and total_containers > 0 %}
            <span class="badge rounded-pill bg-success py-1 px-2">
              <i class="bi bi-hdd-stack me-1"></i>
              All Up
            </span>
            {% else %}
            <span class="badge rounded-pill bg-secondary py-1 px-2">
              <i class="bi bi-hdd-stack me-1"></i>
              {{ up_containers }}/{{ total_containers }} Up
            </span>
            {% endif %}
          </div>
        </div>

        <div class="dashboard-icon d-flex align-items-center justify-content-center rounded" 
          data-icon="{{ service.homepage_icon }}" 
          style="width: 50px; height: 50px;">
        </div>
      </div>
    </div>

    <div class="card-body px-0 py-0">
      <div class="mx-2 mt-2">
        {{ render_routing(service, request) }}
        {{ render_access(service) }}
        {{ render_autostart(service) }}
        <!-- {{ render_autoupdate(service) }} -->
        {{ render_containers(service, containers) }}
      </div>
    </div>

  </div>
</div>
{% endmacro %}

{% block content %}
<div class="row">
  <div class="col-12">

    {{ summary_panel([
      {'value': services|selectattr("core_service")|list|length,'label': 'Core Services','icon': 'check-circle','bg_class': 'bd-indigo-700'},
      {'value': services|length,'label': 'Total','icon': 'list-ul','bg_class': 'bg-primary'},
      {'value': services|rejectattr("enabled")|list|length,'label': 'Disabled','icon': 'x-circle','bg_class': 'bg-dark','text_class': 'text-light'}
    ]) }}

    {% if services %}
    {{ search_bar("Search services by name") }}
    <div class="row g-3 mb-5">
      {% for service in services %}
        {{ service_card(service, containers) }}
      {% endfor %}
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="text-center py-5">
      <div class="card">
        <div class="card-body py-5">
          <i class="bi bi-inbox display-1 text-muted mb-3"></i>
          <h4 class="text-muted mb-3">No Services Configured</h4>
          <p class="text-muted mb-4">
            Define your LoStack configuration using labels in docker-compose.py or lostack-compose.py
          </p>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="deleteServiceModal" tabindex="-1" aria-labelledby="deleteServiceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteServiceModalLabel">
          <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>
          Confirm Service Deletion
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Are you sure you want to delete this service?</strong></p>
        <p class="mb-3">Uninstalling a service will:</p>
        <ol class="mb-3">
          <li>Delete the service from the LoStack database</li>
          <li>Remove the router, middleware, and service from the dynamic Traefik config</li>
          <li>Kill all service containers</li>
          <li>Remove all service containers</li>
          <li>Remove the services from dynamic compose</li>
        </ol>
        <p class="mb-0"><strong>It will not:</strong></p>
        <ul class="mb-0">
          <li>Delete persistent data saved in volumes</li>
          <li>Purge image data from Docker builder</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash me-1"></i>
          Yes, Delete Service
        </button>
      </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('services.static', filename='js/services.js' ) }}"></script>

<script>
function filterServices() {
  const searchInput = document.getElementById('Search');
  const searchTerm = searchInput.value.toLowerCase().trim();
  const serviceCards = document.querySelectorAll('.service-card');
  let visibleCount = 0;

  serviceCards.forEach(card => {
    const cardContainer = card.closest('.col-lg-6, .col-xxl-4');
    const serviceNameElement = card.querySelector('.card-header label.fw-bold');

    if (serviceNameElement) {
      const serviceName = serviceNameElement.textContent.toLowerCase().trim();
      const shouldShow = searchTerm === '' || serviceName.includes(searchTerm);

      if (shouldShow) {
        cardContainer.style.display = '';
        visibleCount++;
      } else {
        cardContainer.style.display = 'none';
      }
    }
  });

  updateEmptyState(visibleCount);
}


function updateEmptyState(visibleCount) {
  const existingMessage = document.getElementById('no-results-message');
  if (existingMessage) {
      existingMessage.remove();
  }

  const searchInput = document.getElementById('Search');
  const searchTerm = searchInput.value.toLowerCase().trim();
  
  if (searchTerm && visibleCount === 0) {
    const servicesContainer = document.querySelector('.row.g-3.mb-5');
    if (servicesContainer) {
      const noResultsHtml = `
        <div id="no-results-message" class="col-12">
          <div class="text-center py-5">
            <div class="card">
              <div class="card-body py-5">
                <i class="bi bi-search display-1 text-muted mb-3"></i>
                <h4 class="text-muted mb-3">No Services Found</h4>
                <p class="text-muted mb-4">
                    No services match your search for "<strong>${escapeHtml(searchInput.value)}</strong>"
                </p>
                <button class="btn btn-outline-primary" onclick="clearSearch()">
                    <i class="bi bi-x-circle me-1"></i>
                    Clear Search
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      servicesContainer.insertAdjacentHTML('beforeend', noResultsHtml);
    }
  }
}

function clearSearch() {
  const searchInput = document.getElementById('Search');
  searchInput.value = '';
  filterServices();
  searchInput.focus();
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function initializeSearch() {
  const searchInput = document.getElementById('Search');
  if (!searchInput) return;
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.activeElement === searchInput) {
      clearSearch();
    }
  });
      
  let searchTimeout;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(filterServices, 50);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  initializeSearch();
  document.querySelectorAll('.dashboard-icon').forEach(function(iconContainer) {
    const iconName = iconContainer.getAttribute('data-icon');
    const iconElement = createServiceIcon(iconName, 50);
    iconContainer.appendChild(iconElement);
  });
});
</script>

{% endblock %}