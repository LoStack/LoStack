{% extends "ldap_base.html" %}

{% block ldap_nav_content %}
<div class="btn-group">
  <a href="{{ url_for('ldap.users') }}" class="btn btn-outline-light">
    <i class="bi bi-arrow-left me-1"></i> Back to Users
  </a>
</div>
{% endblock %}

{% macro render_field(field, readonly=False, help_text=None, col_class="col-md-6") %}
<div class="{{ col_class }}">
  {{ field.label(class="form-label") }}
  {% if help_text %}
  <small class="text-muted">{{ help_text }}</small>
  {% endif %}
  {{ field(class="form-control" + (" is-invalid" if field.errors else ""), readonly=readonly) }}
  {% if field.errors %}
  <div class="invalid-feedback">
    {% for error in field.errors %}{{ error }}{% endfor %}
  </div>
  {% endif %}
</div>
{% endmacro %}

{% macro render_checkbox(field) %}
<div class="form-check">
  {{ field(class="form-check-input") }}
  {{ field.label(class="form-check-label") }}
</div>
{% endmacro %}

{% macro render_card(title, header_class="") %}
<div class="card">
  <div class="card-header{{ ' ' + header_class if header_class }} bg-dark text-light">
    <h5 class="mb-0{{ ' text-danger' if header_class == 'bg-danger-subtle' }}">{{ title }}</h5>
  </div>
  <div class="card-body">
{% endmacro %}

{% macro end_card() %}
  </div>
</div>
{% endmacro %}

{% block page_title %}<i class="bi bi-person-{% if action == 'Create' %}plus{% else %}gear{% endif %} me-2"></i>{{
action }} User{% endblock %}

{% block ldap_content %}
<form method="POST" novalidate>
  {{ form.hidden_tag() }}

  <div class="row">
    <div class="col-lg-8 mb-3">
      {{ render_card("User Information") }}
      <div class="row mb-3">
        {{ render_field(form.username, readonly=(action == 'Edit')) }}
        {{ render_field(form.email) }}
      </div>

      <div class="row mb-3">
        {{ render_field(form.first_name) }}
        {{ render_field(form.last_name) }}
      </div>

      <div class="row mb-3">
        {{ render_field(form.password, help_text="(leave blank to keep current)" if action == 'Edit' else None)
        }}
        {{ render_field(form.confirm_password) }}
      </div>

      <div class="row mb-3">
        {{ render_field(form.phone) }}
        {{ render_field(form.department) }}
      </div>

      <div class="mb-3">
        {{ render_field(form.title, col_class="col-12") }}
      </div>

      <div class="mb-3">
        {{ render_checkbox(form.is_active) }}
      </div>
      {{ end_card() }}
    </div>

    <div class="col-lg-4">
      {{ render_card("Group Membership") }}
      {{ form.groups.label(class="form-label") }}
      <div class="form-check-group" style="max-height: 300px; overflow-y: auto;">
        {% for subfield in form.groups %}
        <div class="form-check">
          {{ subfield(class="form-check-input", id=subfield.id) }}
          {{ subfield.label(class="form-check-label", for=subfield.id) }}
        </div>
        {% endfor %}
      </div>
      {% if not form.groups.choices %}
      <div class="text-muted text-center py-3">
        <i class="bi bi-info-circle"></i> No groups available
      </div>
      {% endif %}
      {{ end_card() }}

      {% if action == 'Edit' %}
      <div class="mt-3">
        {{ render_card("Danger Zone", header_class="bg-danger-subtle") }}
        <p class="text-muted small">Once you delete a user, there is no going back.</p>
        <button type="button" class="btn btn-danger btn-sm w-100" onclick="deleteUser('{{ username }}')">
          <i class="bi bi-trash me-1"></i> Delete User
        </button>
        {{ end_card() }}
      </div>
      {% endif %}
    </div>
  </div>

  <div class="row mt-3 mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
          Cancel
        </button>
        <button type="submit" class="btn btn-success">
          <i class="bi bi-check-lg me-1"></i> {{ action }} User
        </button>
      </div>
    </div>
  </div>
</form>
{% endblock %}