{% extends "core.html" %}

{% block title %}{{ action }} Route - LoStack Admin{% endblock %}

{% block page_title %}<i class="bi bi-{% if action == 'Edit' %}gear{% else %}plus-circle{% endif %} me-2"></i>{{ action }} Route{% endblock %}

{% block nav_actions %}
<div class="btn-group">
  <a href="{{ url_for('traefik_routes.routes') }}" class="btn btn-outline-light">
    <i class="bi bi-arrow-left me-1"></i> Back to Routes
  </a>
</div>
{% endblock %}

{% macro render_field(field, readonly=False, help_text=None, col_class="col-md-6", field_type="input") %}
<div class="{{ col_class }}">
  {% if field_type == "switch" %}
  <div class="form-check form-switch">
    {{ field(class="form-check-input" + (" is-invalid" if field.errors else ""), readonly=readonly) }}
    {{ field.label(class="form-check-label") }}
    {% if field.errors %}
    <div class="invalid-feedback">
      {% for error in field.errors %}{{ error }}{% endfor %}
    </div>
    {% endif %}
  </div>
  {% if help_text or field.description %}
  <div class="form-text">
    <i class="bi bi-info-circle me-1"></i>
    {{ help_text or field.description }}
  </div>
  {% endif %}
  {% else %}
  {{ field.label(class="form-label") }}
  {% if field_type == "select" %}
  {{ field(class="form-select" + (" is-invalid" if field.errors else ""), readonly=readonly) }}
  {% else %}
  {{ field(class="form-control" + (" is-invalid" if field.errors else ""), readonly=readonly) }}
  {% endif %}
  {% if field.errors %}
  <div class="invalid-feedback">
    {% for error in field.errors %}{{ error }}{% endfor %}
  </div>
  {% endif %}
  {% if help_text or field.description %}
  <div class="form-text">
    <i class="bi bi-info-circle me-1"></i>
    {{ help_text or field.description }}
  </div>
  {% endif %}
  {% endif %}
</div>
{% endmacro %}

{% macro render_card(title, header_class="") %}
<div class="card">
  <div class="card-header{{ ' ' + header_class if header_class }} bg-dark text-light">
    <h5 class="mb-0{{ ' text-danger' if header_class == 'bg-danger-subtle' }}">{{ title }}</h5>
  </div>
  <div class="card-body">
    {% endmacro %}

    {% macro end_card() %}
  </div>
</div>
{% endmacro %}

{% block content %}
<form class="mb-5" method="POST" novalidate>
  {{ form.hidden_tag() }}

  <div class="row">
    <div class="col-lg-8 mb-3">
      {{ render_card("Route Configuration") }}
      <div class="row mb-3">
        {{ render_field(form.enabled, field_type="switch", col_class="col-12") }}
      </div>
      {{ end_card() }}

      <div class="mt-3">
        {{ render_card("Basic Configuration") }}
        <div class="row mb-3">
          {{ render_field(form.name) }}
          {{ render_field(form.prefix) }}
        </div>
        <div class="row mb-3">
          {{ render_field(form.host) }}
          {{ render_field(form.port) }}
        </div>
        <div class="row mb-3">
          {{ render_field(form.use_https, field_type="switch") }}
          {{ render_field(form.use_insecure_transport, field_type="switch") }}
        </div>
        <div class="row mb-3">
          {{ render_field(form.middlewares, col_class="col-12") }}
        </div>
        {{ end_card() }}
      </div>

      <div class="mt-3">
        {{ render_card("Dashboard Configuration") }}
        <div class="row mb-3">
          {{ render_field(form.homepage_name) }}
          {{ render_field(form.homepage_icon) }}
        </div>
        <div class="row mb-3">
          {{ render_field(form.homepage_group) }}
          {{ render_field(form.homepage_description) }}
        </div>
        {{ end_card() }}
      </div>
    </div>

    <div class="col-lg-4">
      <div class="mt-0 mb-3">
        {{ render_card("Access Control") }}
        <div class="mb-3">
          {{ render_field(form.lostack_access_enabled, field_type="switch", col_class="col-12") }}
        </div>

        <div class="mb-3">
          {{ form.access_groups.label(class="form-label") }}
          {% if form.access_groups.description %}
          <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>
            {{ form.access_groups.description }}
          </div>
          {% endif %}
          <div class="form-check-group" style="max-height: 300px; overflow-y: auto;">
            {% for subfield in form.access_groups %}
            <div class="form-check">
              {{ subfield(class="form-check-input", id=subfield.id) }}
              {{ subfield.label(class="form-check-label", for=subfield.id) }}
            </div>
            {% endfor %}
          </div>
          {% if form.access_groups.errors %}
          <div class="invalid-feedback d-block">
            {% for error in form.access_groups.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>
        {{ end_card() }}
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
          Cancel
        </button>
        <button type="submit" class="btn btn-success">
          <i class="bi bi-check-lg me-1"></i> {{ action }} Route
        </button>
      </div>
    </div>
  </div>
</form>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('traefik_routes.static', filename='js/route_form.js' ) }}"></script>
{% endblock %}