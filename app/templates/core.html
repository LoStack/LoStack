<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}LoStack Admin{% endblock %}</title>
  
  <!-- Bootstrap & Icons -->
  <link id="bootstrap-base" href="{{ url_for('static', filename='css/bootstrap-5.1.3/bootstrap.min.css' ) }}" rel="stylesheet" type="text/css">
  <link id="bootstrap-icons" href="{{ url_for('static', filename='css/bootstrap-icons/1.13.1/font/bootstrap-icons.min.css' ) }}" rel="stylesheet" type="text/css">

  <!-- CodeMirror -->
  <link href="{{ url_for('static', filename='css/codemirror/5.65.16/lib/codemirror.min.css' ) }}" rel="stylesheet" type="text/css">
  <link href="{{ url_for('static', filename='css/codemirror/5.65.16/addon/lint/lint.min.css' ) }}" rel="stylesheet" type="text/css">

  <!-- Favicon -->
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

  <!-- Theme overrides -->
  {% if selected_theme and not selected_theme == "default" %}
    <link id="bootswatch-theme" href="{{ url_for('static', filename='css/bootswatch/'+selected_theme+'/bootstrap.min.css' ) }}" rel="stylesheet" type="text/css">
  {% else %}
    <!-- Placeholder for settings page / live update -->
    <link id="bootswatch-theme" href="" rel="stylesheet" type="text/css">
  {% endif %}

  {% if selected_editor_theme and not selected_editor_theme == "default" %}
    <link href="{{ url_for('static', filename='css/codemirror/5.65.16/theme/'+selected_editor_theme+'.min.css' ) }}" rel="stylesheet" type="text/css">
  {% endif %}

  {% if custom_css_data %}
    <style id="custom_css_data" >
      {{ custom_css_data | safe }}
    </style>
  {% endif %}

  <link href="{{ url_for('static', filename='css/main.css' ) }}" rel="stylesheet" type="text/css">

  {% block head %}{% endblock %}
</head>
<body>
  <div class="container-fluid bg-transparent">
    <div class="row bg-transparent">
      {# <!-- Sidebar --> #}
      <div class="col-md-3 col-lg-2 sidebar bg-dark px-0">
        <div class="p-3">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="text-light mb-0">
              <i class="bi bi-gear-fill me-2"></i> LoStack
            </h5>
            <button class="btn btn-link text-light p-0 d-md-none" 
              type="button" 
              data-bs-toggle="collapse" 
              data-bs-target="#sidebarNav" 
              aria-expanded="false" 
              aria-controls="sidebarNav"
            >
              <i class="bi bi-list"></i>
            </button>
          </div>

          {# <!-- Collapsible Sidebar Nav --> #}
          <div class="collapse d-md-block sidebar-collapse" id="sidebarNav">
            {% for section, items in nav_links.items() %}
              <nav class="nav flex-column">
                {% for item in items %}
                  {% set _title, endpoint, compare_val, icon = item %}
                  <a class="nav-link text-light {% if request.endpoint.startswith(compare_val) %}active{% endif %}" 
                    href="{{ url_for(endpoint) }}"
                  >
                    <i class="bi bi-{{icon}} me-2"></i>{{_title}}
                  </a>
                {% endfor %}
              </nav>
              <hr class="text-light">
            {% endfor %}
                      
            {# <!-- User Info --> #}
            <div class="mt-auto text-light small">
              <div>
                <i class="bi bi-person-circle me-1"></i>
                {{ g.user if g.user else 'Unknown' }}
              </div>
              {% if g.groups %}
              <div class="mt-1">
                <i class="bi bi-people me-1"></i>
                {{ g.groups|join(', ') }}
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        </div>

        {# <!-- Main Content --> #}
        <div class="col-md-9 col-lg-10 main-content">
          {% if not page_title_disabled %}
          <nav class="navbar shadow-sm bg-dark px-3 py-2 my-2 mb-3">
            <div class="d-flex align-items-center">
              {# <!-- Mobile toggle button --> #}
              <button class="btn btn-link text-light p-0 me-3 d-md-none" 
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#sidebarNav"
                aria-expanded="false"
                aria-controls="sidebarNav"
              >
                <i class="bi bi-list"></i>
              </button>

              <span class="navbar-brand mb-0 h1 text-light">
                  {% block page_title %}LoStack{% endblock %}
              </span>
            </div>

            <div class="d-flex align-items-center">
              {% block nav_actions %}{% endblock %}
            </div>
          </nav>
          {% endif %}

          {# <!-- Flashed Messages --> #}
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              <div class="alert-container">
                {% for category, message in messages %}
                  <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    <i class=" me-2 bi bi-{% if category == 'success' %}check-circle{% elif category == 'error' or category == 'danger' %}exclamation-triangle{% elif category == 'warning' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  </div>
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
          <div class="p-4 py-0 px-0">
            {# <!-- Page Content --> #}
            {% block content %}{% endblock %}
          </div>
        </div>
      </div>
  </div>

  {# <!-- Terminal Modal --> #}
  <div
    class="modal fade"
    id="terminalModal"
    tabindex="-1"
    aria-labelledby="terminalModalLabel"
    aria-hidden="true"
    data-bs-backdrop="static"
    data-bs-keyboard="false"
  >
    <div class="modal-dialog modal-xl">
      <div class="modal-content bg-dark">
        <div class="modal-header bg-dark text-light border-secondary">
          <h5 class="modal-title" id="terminalModalLabel">
            <i class="bi bi-terminal me-2"></i> Terminal Output
          </h5>
          <div class="d-flex align-items-center gap-3">
            <label class="form-check form-switch text-light d-flex align-items-center gap-2 mb-0">
              <input class="form-check-input" type="checkbox" id="modalAutoscrollToggle" checked>
              <span class="user-select-none">Auto-Scroll</span>
            </label>
            <label class="form-check form-switch text-light d-flex align-items-center gap-2 mb-0">
              <input class="form-check-input" type="checkbox" id="modalWrapLinesToggle">
              <span class="user-select-none">Wrap Lines</span>
            </label>
            <button id="modalCopyButton" class="btn btn-sm btn-outline-info px-3" title="Copy all text">Copy</button>
            <button id="modalPauseButton" class="btn btn-sm btn-outline-warning px-3" title="Pause/Resume stream">Pause</button>
          </div>
        </div>
        <div class="modal-body p-0" style="height: 60vh;">
          <pre
            id="modalLog" 
            class="h-100 m-0 p-3 modal-log" 
            tabindex="0"
            role="log"
            aria-live="polite"
            aria-label="Terminal output"
            ></pre>
        </div>
        <div class="modal-footer bg-dark border-secondary">
          <div class="me-auto">
            <span id="streamStatus" class="badge bg-secondary">Connecting...</span>
          </div>
          <button type="button" class="btn btn-secondary" id="doneButton" disabled>Done</button>
        </div>
      </div>
    </div>
  </div>

  {# <!-- Terminal Toast Container --> #}
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="modalCopyToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body bg-primary text-light">Content copied to clipboard!</div>
    </div>
    <div id="modalPauseToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body bg-primary text-light">
        <span id="modalPauseToastText">Stream paused</span>
      </div>
    </div>
  </div>

  {# <!-- Scripts --> #}
  <script src="{{ url_for('static', filename='js/ansi_up/5.1.0/ansi_up.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap-5.1.3/bootstrap.bundle.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/codemirror/5.65.16/lib/codemirror.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/codemirror/5.65.16/mode/yaml/yaml.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/codemirror/5.65.16/addon/lint/lint.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/codemirror/5.65.16/addon/mode/overlay.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/codemirror/5.65.16/mode/meta.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/codemirror/5.65.16/addon/edit/closebrackets.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/codemirror/5.65.16/addon/edit/matchbrackets.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/codemirror/5.65.16/addon/selection/active-line.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/js-yaml-4.1.0/js-yaml.min.js' ) }}"></script>
  <script src="{{ url_for('static', filename='js/main.js' ) }}"></script>
  {% block scripts %}{% endblock %}
</body>
</html>